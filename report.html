<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Inventory Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS (for styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked (Markdown -> HTML) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- PapaParse (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js (summary chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Print-friendly */
    @media print {
      .no-print { display: none !important; }
      .page-break { page-break-before: always; }
    }

    /* Simple prose styles for Markdown content */
    .prose h1 { font-size: 1.875rem; line-height: 2.25rem; margin-top: 1rem; font-weight: 700; }
    .prose h2 { font-size: 1.5rem; margin-top: 1rem; font-weight: 700; }
    .prose h3 { font-size: 1.25rem; margin-top: 1rem; font-weight: 600; }
    .prose table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; }
    .prose table th, .prose table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
    .prose code { background: #f3f4f6; padding: 0.1rem 0.25rem; border-radius: 0.25rem; }
    .prose a { color: #2563eb; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">Restaurant Inventory – Report Viewer</h1>
      <div class="no-print space-x-2">
        <button onclick="window.print()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow">Print / Save PDF</button>
        <button id="clearBtn" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 shadow">Clear</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Loaders -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 no-print">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Load Markdown Report</h2>
        <p class="text-sm text-gray-600 mb-3">Select your <code>inventory_analysis_report.md</code> generated by the Python script.</p>
        <input id="mdInput" type="file" accept=".md,text/markdown,text/plain" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Load CSV Slices (Optional)</h2>
        <p class="text-sm text-gray-600">Load any of the CSVs the script created:</p>
        <ul class="list-disc ml-6 text-sm text-gray-700 mb-3">
          <li><code>expired_items.csv</code></li>
          <li><code>expiring_7d_items.csv</code></li>
          <li><code>fresh_items.csv</code></li>
        </ul>
        <input id="csvInput" type="file" accept=".csv" multiple class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
      </div>
    </section>

    <!-- KPIs + Chart -->
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-sm text-gray-500">Expired</div>
        <div id="kpiExpired" class="text-3xl font-bold">—</div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-sm text-gray-500">Expiring ≤ 7 days</div>
        <div id="kpiExpiring" class="text-3xl font-bold">—</div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-sm text-gray-500">Fresh</div>
        <div id="kpiFresh" class="text-3xl font-bold">—</div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-sm text-gray-500 mb-2">Summary</div>
        <canvas id="summaryChart" height="120" aria-label="Inventory summary chart"></canvas>
      </div>
    </section>

    <!-- Markdown Report -->
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Markdown Report</h2>
      <div id="mdContainer" class="prose max-w-none text-[15px] leading-7">
        <p class="text-gray-500">Load <code>inventory_analysis_report.md</code> to view it here.</p>
      </div>
    </section>

    <!-- CSV Tables -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="text-lg font-semibold mb-3">Expired Items</h3>
        <div id="tblExpired" class="overflow-auto text-sm">
          <p class="text-gray-500">Load <code>expired_items.csv</code>.</p>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="text-lg font-semibold mb-3">Expiring ≤ 7 days</h3>
        <div id="tblExpiring" class="overflow-auto text-sm">
          <p class="text-gray-500">Load <code>expiring_7d_items.csv</code>.</p>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <h3 class="text-lg font-semibold mb-3">Fresh Items</h3>
        <div id="tblFresh" class="overflow-auto text-sm">
          <p class="text-gray-500">Load <code>fresh_items.csv</code>.</p>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-500 py-8">
      Built for your Bedrock + Strands inventory pipeline. Open locally; no uploads.
    </footer>
  </main>

  <script>
    // ---------- State ----------
    let counts = { expired: 0, expiring: 0, fresh: 0 };
    let chart;

    // ---------- Utils ----------
    function renderMarkdown(text) {
      const html = marked.parse(text ?? "");
      document.getElementById("mdContainer").innerHTML = html;
      // Try to extract counts from headings if present (best-effort)
      tryPullCountsFromMarkdown();
      refreshKpis();
      drawChart();
    }

    function csvToTable(containerId, rows) {
      const el = document.getElementById(containerId);
      if (!rows || rows.length === 0) {
        el.innerHTML = '<p class="text-gray-500">No data.</p>';
        return;
      }
      const headers = rows[0];
      const body = rows.slice(1);

      const thead = `<thead><tr>${headers.map(h => `<th class="border px-2 py-1 bg-gray-50">${escapeHtml(h)}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${
        body.map(r => `<tr>${r.map(c => `<td class="border px-2 py-1">${escapeHtml(c)}</td>`).join("")}</tr>`).join("")
      }</tbody>`;

      el.innerHTML = `<table class="w-full border border-gray-200 text-sm">${thead}${tbody}</table>`;
    }

    function escapeHtml(v) {
      if (v === null || v === undefined) return "";
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function refreshKpis() {
      document.getElementById("kpiExpired").textContent = counts.expired || "0";
      document.getElementById("kpiExpiring").textContent = counts.expiring || "0";
      document.getElementById("kpiFresh").textContent = counts.fresh || "0";
    }

    function drawChart() {
      const ctx = document.getElementById("summaryChart");
      const data = {
        labels: ["Expired", "Expiring ≤ 7d", "Fresh"],
        datasets: [{
          label: "Items",
          data: [counts.expired, counts.expiring, counts.fresh]
        }]
      };
      const options = {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, precision: 0 } }
      };
      if (chart) chart.destroy();
      chart = new Chart(ctx, { type: "bar", data, options });
    }

    function tryPullCountsFromMarkdown() {
      // Best-effort parse counts from typical text in the report summary, e.g.
      // "Counts → expired: 2, expiring ≤7 days: 3, fresh: 10"
      const text = document.getElementById("mdContainer").innerText || "";
      const re = /expired:\s*(\d+).{0,20}?expiring[^\d]*?(\d+).{0,20}?fresh:\s*(\d+)/i;
      const m = text.match(re);
      if (m) {
        counts.expired = parseInt(m[1], 10);
        counts.expiring = parseInt(m[2], 10);
        counts.fresh = parseInt(m[3], 10);
      }
    }

    function guessSliceTarget(name) {
      const n = name.toLowerCase();
      if (n.includes("expired")) return "tblExpired";
      if (n.includes("7") || n.includes("expiring")) return "tblExpiring";
      if (n.includes("fresh")) return "tblFresh";
      // fallback: treat as fresh
      return "tblFresh";
    }

    function updateCountsFromCSV(name, rows) {
      // fallback counts from CSV row lengths if provided
      const len = Math.max(0, (rows?.length || 1) - 1); // minus header
      if (name.includes("expired")) counts.expired = len;
      else if (name.includes("expiring")) counts.expiring = len;
      else if (name.includes("fresh")) counts.fresh = len;
      refreshKpis();
      drawChart();
    }

    // ---------- Event handlers ----------
    document.getElementById("mdInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      renderMarkdown(text);
    });

    document.getElementById("csvInput").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      for (const f of files) {
        await new Promise((resolve) => {
          Papa.parse(f, {
            complete: (res) => {
              const rows = res?.data || [];
              const target = guessSliceTarget(f.name || "");
              csvToTable(target, rows);
              updateCountsFromCSV((f.name || "").toLowerCase(), rows);
              resolve();
            },
            error: () => resolve()
          });
        });
      }
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      // Reset UI
      document.getElementById("mdContainer").innerHTML =
        '<p class="text-gray-500">Load <code>inventory_analysis_report.md</code> to view it here.</p>';
      document.getElementById("tblExpired").innerHTML =
        '<p class="text-gray-500">Load <code>expired_items.csv</code>.</p>';
      document.getElementById("tblExpiring").innerHTML =
        '<p class="text-gray-500">Load <code>expiring_7d_items.csv</code>.</p>';
      document.getElementById("tblFresh").innerHTML =
        '<p class="text-gray-500">Load <code>fresh_items.csv</code>.</p>';
      counts = { expired: 0, expiring: 0, fresh: 0 };
      refreshKpis();
      drawChart();
      document.getElementById("mdInput").value = "";
      document.getElementById("csvInput").value = "";
    });

    // Initialize KPIs/chart on first load
    refreshKpis();
    drawChart();
  </script>
</body>
</html>
